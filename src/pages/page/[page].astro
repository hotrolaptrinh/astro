---
import { getCollection } from "astro:content";
import Base from "../../layouts/Base.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProjectCard from "../../components/ProjectCard.astro";
import Pagination from "../../components/Pagination.astro";
import BackToTop from "../../components/BackToTop.astro";
import { PROJECTS_PER_PAGE } from "../../consts";

export async function getStaticPaths() {
  const all = await getCollection("projects");
  const published = all.filter(p => p.data.published);
  const totalPages = Math.max(1, Math.ceil(published.length / PROJECTS_PER_PAGE));
  return Array.from({ length: totalPages }, (_, i) => ({ params: { page: String(i + 1) } }));
}

const allProjects = await getCollection("projects");
const projects = allProjects
  .filter(p => p.data.published)
  .sort((a,b) => b.data.date.getTime() - a.data.date.getTime());

const pageParam = Math.max(1, Number(Astro.params.page || 1));
const totalPages = Math.max(1, Math.ceil(projects.length / PROJECTS_PER_PAGE));
const currentPage = Math.min(pageParam, totalPages);
const start = (currentPage - 1) * PROJECTS_PER_PAGE;
const pageItems = projects.slice(start, start + PROJECTS_PER_PAGE);
---
<Base title={`Trang ${currentPage}`}>
  <Fragment slot="header"><Header /></Fragment>

  <section id="projects" class="py-12 fade-in">
    <h2 class="text-2xl font-bold mb-6">Danh sách dự án</h2>
    <div class="grid gap-6 sm:grid-cols-3 lg:grid-cols-4">
      {pageItems.map((p) => (
        <a href={`${Astro.site?.pathname}projects/${p.slug}`}><ProjectCard {...p.data} /></a>
      ))}
    </div>
    <Pagination page={currentPage} total={totalPages} usePath={true} basePath={Astro.site?.pathname || "/"} />
  </section>

  <Fragment slot="footer">
    <BackToTop />
    <Footer />
  </Fragment>
</Base>

